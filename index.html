<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Intellicheck | UPI Fraud Detection Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Refined Color Palette & Gradients */
    :root {
      --primary-blue-dark: #2A52BE; 
      --primary-blue-light: #4A77E2; 
      --secondary-green: #00BF80; 
      --error-red: #E74C3C; 
      --background-gradient-start: #E0EBF7; 
      --background-gradient-end: #F7FBFF; 
      --card-bg: #ffffff;
      --text-dark: #34495E; 
      --text-medium: #7F8C8D; 
      --text-light: #BDC3C7; 
      --border-light: #EAECEE; 
      --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.05);
      --shadow-medium: 0 10px 30px rgba(0, 0, 0, 0.08);
      --border-radius-card: 18px;
      --border-radius-element: 10px;
      /* SHAP Colors - Swapped colors to match common SHAP visual convention: Red=Risk Up, Blue=Risk Down */
      --shap-increase-risk: #E74C3C; /* Red for increasing fraud risk (matching --error-red) */
      --shap-decrease-risk: #4A77E2; /* Blue for decreasing fraud risk (matching --primary-blue-light) */
      --shap-base: #BDC3C7; /* Base prediction color */
    }
    
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    
    body {
      background: linear-gradient(135deg, var(--background-gradient-start) 0%, var(--background-gradient-end) 100%);
      min-height: 100vh;
      margin: 0;
      display: flex; 
      justify-content: center; 
      align-items: center;
      padding: 40px 20px;
      color: var(--text-dark);
      overflow-x: hidden; 
    }
    
    .container {
      background: var(--card-bg);
      padding: 45px 40px;
      border-radius: var(--border-radius-card);
      box-shadow: var(--shadow-medium);
      width: 95%;
      max-width: 1050px; 
      text-align: center;
      transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); 
      opacity: 1;
      transform: translateY(0);
    }
    
    .hidden { 
      opacity: 0; 
      pointer-events: none; 
      transform: translateY(20px) scale(0.98); 
    }

    /* --- Header & Title (No change) --- */
    .logo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 25px;
    }

    .logo-svg {
      width: 32px;
      height: 32px;
      stroke: url(#logo-gradient); 
      stroke-width: 2.8;
      margin-right: 8px;
    }

    .logo-text {
      font-size: 1.6rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--primary-blue-dark), var(--primary-blue-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    h1 { 
      font-size: 2.2rem; 
      margin-bottom: 8px; 
      font-weight: 700;
      color: var(--text-dark);
    }
    
    h2 { 
      font-size: 1.7rem; 
      margin-top: 0; 
      margin-bottom: 30px;
      color: var(--text-dark);
      position: relative;
      padding-bottom: 15px;
    }
    h2::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-blue-light), var(--primary-blue-dark));
      border-radius: 2px;
    }

    p.tagline { 
      color: var(--text-medium); 
      font-size: 1.05rem; 
      margin-top: 0; 
      margin-bottom: 40px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }
    
    /* --- Form Styling (No change) --- */
    #formPage .content-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 35px; 
    }

    .form-card {
      background: linear-gradient(145deg, #fdfdfd, #f0f4f8);
      padding: 35px;
      border-radius: var(--border-radius-card);
      border: 1px solid var(--border-light);
      width: 100%;
      max-width: 480px; 
      box-shadow: var(--shadow-light);
    }

    .form-card h3 {
      font-size: 1.3rem;
      color: var(--text-dark);
      margin-bottom: 25px;
      font-weight: 600;
    }
    
    form {
      display: grid; 
      grid-template-columns: 1fr 1fr;
      gap: 18px; 
      margin-top: 25px;
    }

    .full-width { grid-column: 1 / -1; }
    
    input, select {
      padding: 14px 18px; 
      border: 1px solid var(--border-light);
      border-radius: var(--border-radius-element);
      font-size: 15px;
      color: var(--text-dark);
      transition: all 0.3s ease;
      width: 100%;
      background-color: #ffffff;
    }
    
    input::placeholder, select option[value=""] {
      color: var(--text-light);
    }

    input:focus, select:focus {
      border-color: var(--primary-blue-light);
      box-shadow: 0 0 0 4px rgba(74, 119, 226, 0.15); 
      outline: none;
      background-color: #fafffe;
    }
    
    .checkbox-group {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-around;
      gap: 25px; 
      margin: 15px 0;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      cursor: pointer;
      color: var(--text-medium);
      font-size: 0.98rem;
      transition: color 0.3s;
    }

    .checkbox-group label:hover {
      color: var(--primary-blue-dark);
    }

    .checkbox-group input[type="checkbox"] {
      appearance: none; 
      width: 20px;
      height: 20px;
      border: 2px solid var(--primary-blue-light);
      border-radius: 6px;
      margin-right: 10px;
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .checkbox-group input[type="checkbox"]:checked {
      background-color: var(--primary-blue-light);
      border-color: var(--primary-blue-light);
    }

    .checkbox-group input[type="checkbox"]:checked::after {
      content: '✓';
      color: white;
      font-size: 14px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      line-height: 1;
    }
    
    button {
      padding: 14px 25px; 
      border: none;
      border-radius: var(--border-radius-element);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      grid-column: 1 / -1;
      letter-spacing: 0.5px;
    }
    
    #submitBtn {
      background: linear-gradient(90deg, var(--primary-blue-light), var(--primary-blue-dark));
      color: white;
      box-shadow: 0 5px 15px rgba(74, 119, 226, 0.3);
    }
    
    #submitBtn:hover:not(:disabled) { 
      background: linear-gradient(90deg, var(--primary-blue-dark), var(--primary-blue-light)); 
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(74, 119, 226, 0.4);
    }

    #submitBtn:disabled {
      background: #CCD1D1;
      box-shadow: none;
      cursor: not-allowed;
      opacity: 0.7;
    }

    #loading { 
      display: none; 
      color: var(--primary-blue-dark); 
      margin-top: 15px; 
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* --- Table Styling (No change) --- */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 35px;
      font-size: 0.9rem;
      overflow: hidden;
      border-radius: var(--border-radius-element);
      box-shadow: var(--shadow-light);
    }
    
    th, td {
      padding: 16px 20px; 
      text-align: left;
    }
    
    th { 
      background: linear-gradient(90deg, var(--primary-blue-light), var(--primary-blue-dark));
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.82rem;
      letter-spacing: 0.5px;
    }

    td {
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-light);
      color: var(--text-dark);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background-color: #f7f9fc;
      transition: background-color 0.2s ease;
    }

    tr.new { animation: highlightRow 2s ease-out; }
    
    @keyframes highlightRow {
      0% { background-color: #FFFDE7; } 
      100% { background-color: var(--card-bg); }
    }
    
    .status-cell {
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px; 
      display: inline-block;
      min-width: 80px;
      text-align: center;
      font-size: 0.8rem;
      letter-spacing: 0.3px;
    }

    .status-fraud {
      color: var(--error-red);
      background-color: #FEF3F2; 
    }

    .status-safe {
      color: var(--secondary-green);
      background-color: #E6FBF5; 
    }
    
    /* --- Chart/Result Page Styling (No change) --- */
    #chartSection {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
      position: relative;
    }

    #pieChart { max-width: 400px; } 

    .action-buttons {
      margin-top: 35px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    
    #downloadBtn {
      background-color: var(--secondary-green);
      color: white;
      box-shadow: 0 5px 15px rgba(0, 191, 128, 0.3);
    }
    
    #downloadBtn:hover { 
      background-color: #00A36D; 
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 191, 128, 0.4);
    }

    #backBtn {
      background-color: var(--text-medium);
      color: white;
      box-shadow: 0 5px 15px rgba(127, 140, 141, 0.2);
    }
    #backBtn:hover {
      background-color: #6C7A89;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(127, 140, 141, 0.3);
    }

    /* --- XAI (SHAP) Waterfall Plot Section (Aesthetic Fixes) --- */
    .xai-section {
      text-align: left;
      margin-top: 40px;
      padding-top: 25px;
      border-top: 1px solid var(--border-light);
    }

    .xai-section h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-blue-dark);
        margin-bottom: 20px;
    }

    .shap-legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-bottom: 30px;
        font-size: 0.95rem;
        color: var(--text-medium);
        font-weight: 500;
    }

    .shap-legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .shap-legend-item span {
        width: 15px;
        height: 15px;
        border-radius: 4px;
        display: inline-block;
    }

    .waterfall-plot {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px 0;
      max-width: 900px; /* Increased max width for better visual spread */
      margin: 0 auto;
    }

    .waterfall-row {
      display: grid;
      /* Define three columns: Feature Label, Bar Container (takes remaining space), Value Text */
      grid-template-columns: 200px 1fr 100px; 
      align-items: center;
      gap: 15px;
      font-size: 0.95rem;
      font-weight: 500;
      padding: 10px 15px;
      border-radius: var(--border-radius-element);
      background-color: #fcfdff; 
      transition: all 0.2s;
    }

    .waterfall-row:hover {
        background-color: #f0f4f8;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Soft shadow on hover */
    }

    .feature-label {
      color: var(--text-dark);
      text-align: left;
      font-weight: 600;
    }

    /* The new visual trick for clean bar rendering */
    .bar-container {
      height: 12px;
      width: 100%;
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      background-color: #F4F7F9; /* Neutral background for the bar track */
    }

    .shap-bar {
      height: 100%;
      position: absolute;
      top: 0;
      /* Bar styles will be set by JS using CSS variables */
      transition: width 0.6s ease-out, left 0.6s ease-out, background-color 0.3s;
      border-radius: 6px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); 
    }

    .shap-value-text {
        text-align: right;
        font-weight: 600;
        font-size: 1rem;
    }

    .total-row {
        margin-top: 15px;
        padding: 15px;
        /* Using the dark blue/white combo for total rows */
        background: var(--primary-blue-dark);
        color: white;
        font-size: 1.1rem;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(42, 82, 190, 0.2);
    }
    
    .total-row .feature-label, .total-row .shap-value-text {
        color: white;
        font-weight: 700;
    }

    /* --- Responsiveness (Updated for new grid layout) --- */
    @media (max-width: 768px) {
      .waterfall-row {
        grid-template-columns: 1fr 1fr; /* Two columns */
        grid-template-rows: auto auto; /* Two rows for content */
        gap: 8px 10px;
        padding: 10px;
      }
      .feature-label {
        grid-column: 1 / 2; /* Label takes first column */
      }
      .shap-value-text {
        grid-column: 2 / 3; /* Value takes second column */
        text-align: right;
      }
      .bar-container {
        grid-column: 1 / -1; /* Bar spans both columns */
        grid-row: 2 / 3; 
        height: 10px;
      }
      .shap-legend {
          flex-direction: column;
          gap: 10px;
      }
    }
    @media (max-width: 600px) {
      /* ... (Existing mobile styles) ... */
    }
  </style>
</head>
<body>
  <div class="container" id="formPage">
    
    <svg width="0" height="0" style="position:absolute;">
      <defs>
        <linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:var(--primary-blue-light);stop-opacity:1" />
          <stop offset="100%" style="stop-color:var(--primary-blue-dark);stop-opacity:1" />
        </linearGradient>
      </defs>
    </svg>

    <div class="logo-container">
      
      <svg class="logo-svg" viewBox="0 0 24 24">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        <path d="M12 16L12 16"></path><path d="M12 12L12 12"></path>
      </svg>
      <span class="logo-text">Intellicheck</span>
    </div>
    <h1>Real-time Fraud Monitor</h1>
    <p class="tagline">An intelligent, AI-powered system designed to provide instant analysis and visualization of UPI transactions, securing your financial ecosystem.</p>

    <div class="content-wrapper">
      <div class="form-card">
        <h3>Simulate a New Transaction</h3>
        <form id="transactionForm">
          <input type="text" id="transaction_id" placeholder="Transaction ID (e.g., TXN1001)" required>
          <input type="text" id="user_id" placeholder="User ID (e.g., U4567)" required>
          <input type="number" id="amount" placeholder="Amount (₹)" required class="full-width">
          <select id="location">
            <option value="">Select Location</option>
            <option>Delhi</option><option>Mumbai</option>
            <option>Bangalore</option><option>Chennai</option><option>Hyderabad</option>
            <option>Pune</option><option>Ahmedabad</option><option>Kolkata</option>
          </select>
          <select id="device_type">
            <option value="">Device Type</option>
            <option>Android</option><option>iOS</option><option>Web</option>
            <option>POS</option><option>Wearable</option>
          </select>
          <div class="checkbox-group">
            <label><input type="checkbox" id="is_kyc_verified"> KYC Verified</label>
            <label><input type="checkbox" id="is_foreign_device"> Foreign Device</label>
          </div>
          <button id="submitBtn" type="button" onclick="submitTransaction()">Analyze Transaction</button>
          <div id="loading"></div> 
        </form>
      </div>

      <div class="placeholder-visual">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
        <p>Your transaction data will be processed and visualized here. Get insights into potential fraud risks with a single click.</p>
      </div>
    </div>
  </div>

  <div class="container hidden" id="resultPage" style="display:none;">
    <h2>Transaction Analysis Dashboard</h2>
    
    <div id="chartSection">
      <canvas id="pieChart" width="300" height="300"></canvas>
    </div>

    <div class="xai-section">
        <h3>Transaction Explanation (SHAP)</h3>
        <p class="tagline" style="margin-bottom: 20px;">The plot below shows how each feature increases (red) or decreases (blue) the prediction of fraud probability from the baseline.</p>
        
        <div class="shap-legend">
            <div class="shap-legend-item"><span style="background-color: var(--shap-increase-risk);"></span> Increases Risk</div>
            <div class="shap-legend-item"><span style="background-color: var(--shap-decrease-risk);"></span> Decreases Risk</div>
            <div class="shap-legend-item"><span style="background-color: var(--shap-base);"></span> Baseline Prediction</div>
        </div>

        <div id="shapWaterfall" class="waterfall-plot">
            </div>
    </div>

    <table id="transactionTable">
      <thead>
        <tr>
          <th>ID</th><th>User</th><th>Amount</th><th>Location</th><th>Probability</th><th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    
    <div class="action-buttons">
      <button id="downloadBtn" onclick="downloadCSV()">⬇️ Download Data</button>
      <button id="backBtn" onclick="goBack()">← New Analysis</button>
    </div>
  </div>

  <script>
    // Utility function to safely get CSS variable values
    const getCssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

    const API_URL = window.location.hostname.includes('localhost')
      ? 'http://127.0.0.1:5000/predict'
      : 'https://your-deployed-backend-url.com/predict';

    let transactions = [];
    let pieChart;

    // --- Chart/Table Functions (Retained) ---
    function initChart() {
        const pieChartCtx = document.getElementById('pieChart').getContext('2d');
        const textDark = getCssVar('--text-dark'); 
        
        if (pieChart) {
            pieChart.destroy();
        }

        pieChart = new Chart(pieChartCtx, {
            type: 'doughnut',
            data: {
                labels: ['Safe Transactions', 'Fraudulent Attempts'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: [getCssVar('--secondary-green'), getCssVar('--error-red')],
                    borderWidth: 3, 
                    borderColor: getCssVar('--card-bg'),
                    hoverBorderWidth: 5
                }]
            },
            options: { 
                cutout: '75%', 
                responsive: true,
                maintainAspectRatio: false, 
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 13,
                                weight: '500'
                            },
                            color: textDark
                        }
                    },
                    title: {
                        display: true,
                        text: 'Safe vs. Fraudulent Transactions',
                        font: { size: 18, weight: '600' },
                        color: textDark,
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    }
                }
            }
        });
        updateCharts(); 
    }
    
    function updateCharts() {
      if (!pieChart) return;
      const fraudCount = transactions.filter(t => t.is_fraud).length;
      const safeCount = transactions.length - fraudCount;
      pieChart.data.datasets[0].data = [safeCount, fraudCount];
      pieChart.update();
    }

    function updateTable() {
      const tbody = document.querySelector('#transactionTable tbody');
      tbody.innerHTML = '';
      
      const recentTransactions = transactions.slice().reverse().slice(0, 10); 
      
      recentTransactions.forEach((t, index) => {
        const row = document.createElement('tr');
        if (index === 0) { 
          row.classList.add('new'); 
        }
        
        const statusClass = t.is_fraud ? 'status-fraud' : 'status-safe';
        const statusText = t.is_fraud ? 'FRAUD' : 'SAFE';

        row.innerHTML = `
          <td>${t.transaction_id}</td>
          <td>${t.user_id}</td>
          <td>₹${t.amount.toLocaleString('en-IN')}</td>
          <td>${t.location}</td>
          <td>${(t.fraud_probability * 100).toFixed(2)}%</td>
          <td><span class="status-cell ${statusClass}">${statusText}</span></td>`;
        tbody.appendChild(row);
      });
    }

    // --- NEW SHAP Logic (Simulated) ---
    function generateShapValues(data, prediction) {
        // Baseline prediction (e.g., average fraud probability in the training data)
        const BASE_VALUE = 0.20; 
        const remaining_diff = prediction - BASE_VALUE;

        // Simplified, mock SHAP logic based on input features:
        let shap_values = [
            { feature: `Amount (₹${data.amount.toLocaleString()})`, value: 0 },
            { feature: `Location (${data.location})`, value: 0 },
            { feature: `Device (${data.device_type})`, value: 0 },
            { feature: `KYC Verified (${data.is_kyc_verified ? 'Yes' : 'No'})`, value: 0 },
            { feature: `Foreign Device (${data.is_foreign_device ? 'Yes' : 'No'})`, value: 0 },
        ];

        // 1. Amount: High amount contributes positively to fraud
        shap_values[0].value = (data.amount > 50000) ? 0.25 : 
                               (data.amount > 10000) ? 0.10 : -0.05;

        // 2. Foreign Device: Strong positive contributor to fraud
        shap_values[4].value = data.is_foreign_device ? 0.35 : -0.15;
        
        // 3. KYC: Strong negative contributor (safe)
        shap_values[3].value = data.is_kyc_verified ? -0.10 : 0.05;

        // 4. Location & Device (minor, random contributions to balance the remaining difference)
        shap_values[1].value = (data.location === 'Kolkata') ? 0.05 : -0.01;
        shap_values[2].value = (data.device_type === 'Wearable') ? 0.08 : -0.03;


        // Recalculate the difference to ensure the sum equals the actual prediction
        const current_sum = shap_values.reduce((sum, item) => sum + item.value, BASE_VALUE);
        const final_adjustment = remaining_diff - (current_sum - BASE_VALUE);
        
        // Apply a small, final adjustment to the most influential feature (Foreign Device) to close the gap
        shap_values[4].value += final_adjustment; 

        // Sort by absolute SHAP value for visualization (most impactful first)
        shap_values.sort((a, b) => Math.abs(b.value) - Math.abs(a.value));

        return { BASE_VALUE, shap_values };
    }

    /**
     * Renders the visually improved SHAP Waterfall Plot.
     * Logic: Calculates positions based on the total 0-to-1 range (probability).
     */
    function renderShapWaterfall(BASE_VALUE, shap_values, final_prediction) {
        const plotContainer = document.getElementById('shapWaterfall');
        plotContainer.innerHTML = '';
        
        const chart_range = 1.0; // Probability is 0 to 1
        let cumulative_sum = BASE_VALUE;

        // --- 1. Base Value Row ---
        const baseRow = document.createElement('div');
        baseRow.className = 'waterfall-row total-row';
        baseRow.innerHTML = `
            <div class="feature-label">Base Prediction (E[f(X)])</div>
            <div class="bar-container">
                <div class="shap-bar" style="
                    width: ${(BASE_VALUE / chart_range) * 100}%;
                    left: 0%;
                    background-color: ${getCssVar('--shap-base')};
                "></div>
            </div>
            <div class="shap-value-text">${(BASE_VALUE * 100).toFixed(1)}%</div>
        `;
        plotContainer.appendChild(baseRow);


        // --- 2. Feature Rows ---
        shap_values.forEach(item => {
            const row = document.createElement('div');
            row.className = 'waterfall-row';

            const isPositive = item.value >= 0;
            // SHAP convention: Red for risk up, Blue for risk down
            const barColor = isPositive ? getCssVar('--shap-increase-risk') : getCssVar('--shap-decrease-risk');
            const barWidth = (Math.abs(item.value) / chart_range) * 100;
            
            // Crucial Fix: Use Math.min to correctly position the start of the bar
            // Start position is either the cumulative sum (for positive) or the end of the bar (for negative)
            const barLeft = isPositive 
                ? (cumulative_sum / chart_range) * 100 
                : ((cumulative_sum + item.value) / chart_range) * 100;

            // Update cumulative sum for the next feature's starting position
            cumulative_sum += item.value;

            row.innerHTML = `
                <div class="feature-label">${item.feature}</div>
                <div class="bar-container">
                    <div class="shap-bar" style="
                        width: ${barWidth}%;
                        left: ${barLeft}%;
                        background-color: ${barColor};
                    "></div>
                </div>
                <div class="shap-value-text" style="color: ${barColor};">
                    ${isPositive ? '+' : ''}${(item.value * 100).toFixed(1)}%
                </div>
            `;
            plotContainer.appendChild(row);
        });

        // --- 3. Final Prediction Row ---
        const finalRow = document.createElement('div');
        finalRow.className = 'waterfall-row total-row';
        finalRow.innerHTML = `
            <div class="feature-label">Final Fraud Probability (f(X))</div>
            <div class="bar-container">
                <div class="shap-bar" style="
                    width: ${(final_prediction / chart_range) * 100}%;
                    left: 0%;
                    background: ${getCssVar('--primary-blue-light')};
                "></div>
            </div>
            <div class="shap-value-text">${(final_prediction * 100).toFixed(1)}%</div>
        `;
        plotContainer.appendChild(finalRow);
    }
    
    // --- Submission Function Update (No change, calls renderShapWaterfall) ---
    async function submitTransaction() {
        const data = {
            transaction_id: document.getElementById('transaction_id').value.trim(),
            user_id: document.getElementById('user_id').value.trim(),
            amount: parseFloat(document.getElementById('amount').value),
            location: document.getElementById('location').value,
            device_type: document.getElementById('device_type').value,
            is_kyc_verified: document.getElementById('is_kyc_verified').checked,
            is_foreign_device: document.getElementById('is_foreign_device').checked
        };
        
        if (!data.transaction_id || !data.user_id || !data.amount || data.amount <= 0 || !data.location || !data.device_type) {
            alert("Please ensure all fields are filled correctly.");
            return;
        }

        const btn = document.getElementById('submitBtn');
        const loader = document.getElementById('loading');
        btn.disabled = true;
        loader.style.display = 'flex'; 

        try {
            // --- Mocking the API call for demonstration ---
            await new Promise(resolve => setTimeout(resolve, 1800)); 
            
            // Generate the prediction
            const fraud_prob_mock = data.amount > 50000 || data.is_foreign_device || !data.is_kyc_verified
            ? Math.min(1.0, 0.5 + Math.random() * 0.5) 
            : Math.max(0.0, 0.05 + Math.random() * 0.25); 
            
            const result = {
                fraud_probability: fraud_prob_mock,
                is_fraud: fraud_prob_mock > 0.4 
            };

            const transaction = {
                ...data,
                fraud_probability: result.fraud_probability,
                is_fraud: result.is_fraud,
                amount: data.amount 
            };
            
            transactions.push(transaction);

            // *** NEW: Generate and render SHAP explanation ***
            const { BASE_VALUE, shap_values } = generateShapValues(data, transaction.fraud_probability);
            renderShapWaterfall(BASE_VALUE, shap_values, transaction.fraud_probability);
            // ***********************************************

            updateTable();
            updateCharts();
            showResultsPage();
            
        } catch (err) {
            alert("Error connecting to the server or processing data. Please check your API_URL.");
            console.error("Submission Error:", err);
        } finally {
            btn.disabled = false;
            loader.style.display = 'none';
        }
    }

    // --- State Management, Navigation, Download (Retained) ---
    window.addEventListener('load', () => {
      const saved = JSON.parse(localStorage.getItem('transactions') || '[]');
      transactions = saved;
      initChart();

      document.getElementById('loading').innerHTML = `
        <div style="
          width: 18px; 
          height: 18px; 
          border: 3px solid ${getCssVar('--primary-blue-light')}; 
          border-top-color: transparent; 
          border-radius: 50%; 
          animation: spin 0.8s linear infinite;"></div> 
        Processing and Analyzing Data...`;
        
      if (transactions.length > 0) {
        updateTable(); 
      }
    });

    window.addEventListener('beforeunload', () => {
      localStorage.setItem('transactions', JSON.stringify(transactions));
    });

    function showResultsPage() {
      const formPage = document.getElementById('formPage');
      const resultPage = document.getElementById('resultPage');
      formPage.classList.add('hidden');
      setTimeout(() => {
        formPage.style.display = 'none';
        resultPage.style.display = 'block';
        resultPage.classList.remove('hidden');
      }, 550); 
    }

    function goBack() {
      const formPage = document.getElementById('formPage');
      const resultPage = document.getElementById('resultPage');
      resultPage.classList.add('hidden');
      setTimeout(() => {
        resultPage.style.display = 'none';
        formPage.style.display = 'block';
        formPage.classList.remove('hidden');
        document.getElementById('transactionForm').reset();
      }, 550);
    }

    function downloadCSV() {
      if (transactions.length === 0) return alert("No data to download.");
      let csv = 'Transaction ID,User ID,Amount,Location,Device Type,KYC Verified,Foreign Device,Fraud Probability,Status\n';
      transactions.forEach(t => {
        csv += `${t.transaction_id},${t.user_id},${t.amount},${t.location},${t.device_type},${t.is_kyc_verified ? "Yes" : "No"},${t.is_foreign_device ? "Yes" : "No"},${t.fraud_probability},${t.is_fraud ? "Fraud" : "Safe"}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'intellicheck_transactions_data.csv';
      link.click();
    }
  </script>
</body>
</html>